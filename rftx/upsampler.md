# Digital interpolation & shaping for 5G-NR (Markdown reference)

> Direct conversion of the earlier explanation into a ready-to-use Markdown reference you can paste into docs.

---

# Overview
You have complex OFDM I/Q samples (with CP) at baseband. The digital interpolation + shaping block prepares those samples for the DAC by:

- increasing sample-rate (interpolation),
- removing images (anti-imaging filtering),
- pulse-shaping / pre-emphasis (compensate analog response),
- optionally digitally upconverting to an IF,
- and preparing numeric scaling/wordwidths for the DAC.

The goals are to protect EVM and ACLR budgets, reduce analog filter burden, and keep group delay flat across the signal band.

---

# Block diagram (logical)
```
Baseband I/Q (e.g., 30.72 MS/s)
  └─> Polyphase interp ×2 (halfband FIR)
      └─> Polyphase interp ×2 (halfband FIR)
          └─> Final shaping FIR (anti-imaging + pre-emph)
              └─> (optional) Digital upconversion (IF)
                  └─> DAC
```

---

# Typical sample-rate chain (example for 100 MHz NR)
- Input: **30.72 MS/s** (common base for 15 kHz grid families)  
- Output target: **245.76 MS/s** (DAC)  
- Overall interpolation: **×8** implemented as three ×2 stages (×2 → ×2 → ×2) and a final shaping stage.

---

# Interpolation stages — practical design
Each stage uses polyphase FIRs (halfband for ×2) for efficiency and linear phase.

## Stage goals
- Remove imaging generated by zero-stuffing/upsampling.
- Preserve flat passband and linear group delay.
- Provide high stopband attenuation to make analog filtering easy.

## Typical stage specs
- Stage 1 (×2 halfband): 20–40 taps, stopband ~ −60 to −80 dB.  
- Stage 2 (×2 halfband): 24–40 taps, stopband ~ −70 to −80 dB.  
- Stage 3 (final ×2 shaping): 64–128 taps, stopband ~ −80 to −95 dB, passband ripple < 0.05 dB.

> Halfband filters are attractive because roughly half the coefficients are zero; polyphase implementation reduces multiply complexity.

---

# Numeric example (recommended chain)

| Stage | Rate (MS/s) | Interp | Method | Example taps / spec |
|-------|-------------:|:------:|:-------|:--------------------|
| Input | 30.72        | —      | baseband | — |
| 1     | 61.44        | ×2     | Halfband polyphase FIR | 31 taps, stopband −70 dB |
| 2     | 122.88       | ×2     | Halfband polyphase FIR | 35 taps, stopband −80 dB |
| 3     | 245.76       | ×2     | Shaping FIR (linear phase) | 64–96 taps, stopband −90 dB |
| (opt) | 245.76       | —      | Digital Upconvert to IF | NCO or CORDIC |

Passband ripple target: **< 0.03–0.05 dB**. Constant (linear) group delay across passband.

---

# Polyphase interpolation: concept & pseudocode

**Concept**: split an L× interpolator into L polyphase branches, each computing one output phase with reduced computation. For ×2 halfband the structure is especially cheap (every other coefficient zero for ideal designs).

**Pseudocode (conceptual):**
```c
// x[n] real or complex baseband
// h[k] polyphase halves for ×2, e.g., h0[], h1[]
// y[m] output (at 2x rate)
for each input sample n:
    // compute contributions for two output samples
    // low-latency pipelined polyphase inner products
    y[2*n]   = dot(h0, x_window0)
    y[2*n+1] = dot(h1, x_window1)
```
In hardware, implement `dot()` as multiply-accumulate pipelined across taps; exploit symmetry (linear-phase) to half multiplies.

---

# Final shaping FIR duties
- Suppress residual images and aliasing to a very deep level (≥ 80–95 dB).
- Compensate DAC sinc (sin(x)/x) response if the DAC has known roll-off.
- Add pre-emphasis to counteract analog front-end droop (mixer, filter, PA).
- Keep linear phase to preserve OFDM symbol orthogonality.

**Design tips**
- Use windowed equiripple (Parks–McClellan) or least-squares linear-phase FIR design.
- Trade taps vs attenuation: more taps → steeper transition & deeper stopband.
- For real-time adaptation (compensation), keep coefficients in memory that can be updated.

---

# Digital upconversion (optional)
Multiply complex baseband by `e^{j2π f_if n / Fs}` to shift to IF. Implement with:

- NCO (phase accumulator) + CORDIC or small LUT for sin/cos.
- If using CORDIC, watch numeric bit growth and phase quantization.

Common IFs at 245.76 MS/s: 30–100 MHz (choose to avoid DC and to match analog mixer/LO choices).

---

# Fixed-point / word-length considerations
- Track bit growth: each FIR MAC increases bit width. Plan truncation/rounding carefully to limit quantization noise and avoid EVM hit.
- Typical strategy:
  - Use internal accumulator width >= (input_bits + coeff_bits + log2(tap_count)).
  - Round or dithering at the final stage before DAC.
- Keep headroom for peaks (OFDM PAPR) — don’t clip; implement scaling or CORDIC gain compensation if needed.

---

# Implementation pointers (FPGA/ASIC)
- Pipeline multiplies and adds heavily; implement multiply-accumulate units with deep pipelining.
- Use symmetric coefficients to half the number of multipliers for linear-phase FIRs.
- For polyphase, implement each phase as its own FIR block or time-multiplex a single FIR across phases if resource constrained.
- Consider using block RAM to store coefficients and circular buffers for input windows.
- If using CIC for very high upsampling, follow with a wideband FIR compensation filter to meet stopband specs.

---

# Why good interpolation matters for 5G NR
- Poor interpolation → DAC images near band → analog filters must be impossibly sharp → EVM/ACLR fail.
- Good digital shaping reduces burden on PA linearity and analog filters, enabling efficient envelope-tracking/DPD strategies.
- Linear-phase FIRs preserve OFDM orthogonality and minimize inter-carrier distortion.

---

# Example checklist before handing samples to DAC
- [ ] Passband ripple ≤ 0.05 dB across signal band.  
- [ ] Stopband attenuation ≥ target (e.g., 80–95 dB depending on analog filter margin).  
- [ ] Group delay flatness verified across channel BW.  
- [ ] Word-lengths verified: accumulator widths, rounding points, no clipping.  
- [ ] Optional IF chosen and NCO jitter/phase resolution acceptable.  
- [ ] Pre-emphasis compensation curve applied (if needed) and verified in loop with analog front end (or measured PA).
